sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/model/Sorter","sap/ui/Device","sap/ui/core/routing/History","sap/m/ColumnListItem","sap/m/Input","sap/base/util/deepExtend","sap/ui/export/Spreadsheet","sap/m/MessageToast","sap/m/MessageBox","sap/m/ObjectIdentifier","sap/m/Text","sap/m/Button","sap/m/Dialog","../utils/formatter"],function(e,t,s,a,r,i,n,o,l,u,d,g,h,c,m,M,I,f,p){"use strict";return e.extend("com.agel.mmts.raisereturnmaterial.controller.RaiseRequestDetailPage",{formatter:p,onInit:function(){this.getView().addEventDelegate({onAfterShow:this.onBeforeShow},this);var e=new t({busy:false,delay:0,boqSelection:null,csvFile:"file"});this.setModel(e,"objectViewModel");this._mViewSettingsDialogs={};this.MainModel=this.getComponentModel();this.getView().setModel(this.MainModel);this.oRouter=this.getRouter();this.oRouter.getRoute("RaiseRequestDetailPage").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=this;var s=e.getParameter("arguments").SOId;t.sObjectId=s;this._bindView("/SONumberDetailsSet("+s+")")},_bindView:function(e){var t=this.getViewModel("objectViewModel");var s=this;this.getView().bindElement({path:e,events:{dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false);s.onReadDataIssueMaterialParents()}}})},onReadDataIssueMaterialParents:function(){var e=this;e.oIssueMaterialModel=new t;this.MainModel.read("/SONumberDetailsSet("+e.sObjectId+")",{urlParameters:{$expand:"IssuedMaterialParent/IssuedMaterialBOQ"},success:function(t,s){e.dataBuilding(t.IssuedMaterialParent.results)}.bind(this),error:function(e){sap.m.MessageBox.error("Data Not Found")}})},dataBuilding:function(e){this.ParentDataView=e;for(var t=0;t<e.length;t++){e[t].ReturnedQty=null;if(e[t].IssuedMaterialBOQ.results.length){this.ParentDataView[t].isStandAlone=false;this.ParentDataView[t].ChildItemsView=e[t].IssuedMaterialBOQ.results}else{this.ParentDataView[t].isStandAlone=true;this.ParentDataView[t].ChildItemsView=[]}for(var s=0;s<e[t].IssuedMaterialBOQ.results.length;s++){e[t].IssuedMaterialBOQ.results[s].ReturnedQty=null}}this.arrangeDataView(this.ParentDataView)},arrangeDataView:function(e){var s=this;var a=new t({ChildItemsView:this.ParentDataView});this.getView().setModel(a,"TreeTableModelView");var r=this.byId("TreeTable");r.setModel(a);r.getModel("TreeTableModelView").refresh()},handleToAllPOBreadcrumPress:function(e){history.go(-1)},onLiveChangeReturnQty:function(e){e.getSource().setValueState("None");this.getView().byId("idBtnSubmit").setEnabled(true);var t=e.getSource().getValue();var s=e.getSource().getParent().getParent().getCells()[4].getText();var a=0;if(parseInt(t)>parseInt(s)||s==""){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter return quantity lesser than or equal to balance quantity");this.getView().byId("idBtnSubmit").setEnabled(false);a=1}if(parseInt(t)<0||t==""){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter return quantity");this.getView().byId("idBtnSubmit").setEnabled(false)}else if(a!=1){e.getSource().setValueState("None");this.getView().byId("idBtnSubmit").setEnabled(true)}},onEditQuantityPressed:function(e){var t=e.getParameter("pressed");if(t)e.getSource().getParent().getItems()[0].setEditable(true);else e.getSource().getParent().getItems()[0].setEditable(false)},onCancelAssistanceRequestPress:function(e){this._oQRAssistantDialog.close()},onLiveChangeComment:function(e){var t=this;var s=this.getView().getModel("qrAssistantModel");var a=e.getSource().getValue();if(a.length<0){s.setProperty("/commentValueState","Error")}else{s.setProperty("/commentValueState","None")}s.refresh()},onReasonSelectionChange:function(e){var t=this;var s=this.getView().getModel("qrAssistantModel");s.setProperty("/reasonValueState","None");s.refresh()},onPressSubmitRequest:function(e){var s=new t({reason:null,reasonValueState:"None",comment:null,commentValueState:"None"});this.getView().setModel(s,"qrAssistantModel");if(!this._oQRAssistantDialog){this._oQRAssistantDialog=sap.ui.xmlfragment("com.agel.mmts.raisereturnmaterial.view.fragments.Reason",this);this.getView().addDependent(this._oQRAssistantDialog)}this._oQRAssistantDialog.open()},onSendAssistanceRequestPress:function(e){var t=this;var s=this.getView().getModel("qrAssistantModel");var a=0;if(s.getProperty("/comment")==null||s.getProperty("/comment")==""){a=1;s.setProperty("/commentValueState","Error")}if(s.getProperty("/reason")==null||s.getProperty("/reason")==""){a=1;s.setProperty("/reasonValueState","Error")}if(a==1){sap.m.MessageBox.error("Please fill mandatory fields");return 0}var r=this.byId("TreeTable").getModel().getData().ChildItemsView;debugger;var i=[];for(var n=0;n<r.length;n++){var o={BOQItem:[]};o["IssuedMaterialParentId"]=r[n].ID;if(r[n].IssuedMaterialBOQ.results.length<1){o["IsBOQPresent"]=false;o["ReturnQty"]=0}else{o["IsBOQPresent"]=true;o["ReturnQty"]=parseInt(r[n].ReturnedQty)}for(var l=0;l<r[n].IssuedMaterialBOQ.results.length;l++){var u={};u["IssuedMaterialBOQId"]=r[n].IssuedMaterialBOQ.results[l].ID;u["ReturnQty"]=parseInt(r[n].IssuedMaterialBOQ.results[l].ReturnedQty)}o["BOQItem"].push(u);i.push(o)}var d=t.getView().byId("idSimpleForm").getBindingContext().getObject().ID;var g={SONumber:t.sObjectId,UserName:"Test",ContractorId:d,ReasonToReturnMaterialId:1,Comment:s.getProperty("/comment"),ParentItem:i};this.MainModel.create("/RaiseReturnMaterialRequestSet",g,{success:function(e,s){t._oQRAssistantDialog.close();sap.m.MessageBox.success(e.Message)}.bind(this),error:function(e){sap.m.MessageBox.error(e.Message)}})},onReadDataIssueMaterials:function(){var e=this;var s=this.byId("idTblIssueMaterialItems");e.oIssueMaterialModel=new t;this.MainModel.read("/SONumberDetailsSet("+e.sObjectId+")/IssuedMaterials",{success:function(t,a){e.oIssueMaterialModel.setData({Items:t.results});s.setModel(e.oIssueMaterialModel,"oIssueMaterialModel")}.bind(this),error:function(e){sap.m.MessageBox.error("Data Not Found")}})}})});